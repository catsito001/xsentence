<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inglés práctico por frases</title>
  <!-- Font Awesome para íconos -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    /* ================= Reset básico ================= */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      font-size: 16px;
    }
    body {
      background-color: #2f2f2f;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      position: relative;
    }

    /* ================= Contenedor principal ================= */
    .container {
      width: 100%;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    h1 {
      text-align: center;
      font-size: 1.9rem;
      margin-bottom: 0.5rem;
    }

    /* ================= Estilos globales de botón ================= */
    button {
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 3px rgba(0,0,0,0.2);
    }

    /* ========== Barra de niveles ========== */
    .level-bar {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .level-bar button {
      flex: 1 1 auto;
      font-size: 0.95rem;
      padding: 0.6rem 1rem;
      background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .level-bar button.active {
      background: linear-gradient(135deg, #138496 0%, #0f6674 100%);
    }

    /* ================ Lista de temas ================ */
    .topics-container {
      display: grid;
      gap: 0.5rem;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
    .topics-container button {
      font-size: 0.95rem;
      padding: 0.7rem 1rem;
      background: linear-gradient(135deg, #fd7e14 0%, #e8590c 100%);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .topics-container button:hover {
      background: linear-gradient(135deg, #e8590c 0%, #c8470a 100%);
    }

    /* ================ Vista de frase ================= */
    .sentence-view {
      display: none; /* oculta por defecto */
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      position: relative;
      padding-top: 4rem; /* espacio para top-controls */
    }
    .sentence-view.active {
      display: flex;
    }

    /* ================= Controles superiores ================= */
    .top-controls {
      display: flex;
      gap: 0.5rem;
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      z-index: 10;
    }
    .top-controls button {
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .top-controls button:hover {
      background: linear-gradient(135deg, #5a6268 0%, #4e555b 100%);
    }

    /* ================= Texto Anterior Probable ================= */
    .previous-container {
      width: 100%;
      background-color: #3b3b3b;
      border: 2px solid #4a4a4a;
      border-radius: 6px;
      text-align: center;
      padding: 0.5rem;
    }
    .previous-text {
      font-size: 1.5rem;
      color: #fff;
      margin-bottom: 0.2rem;
    }
    .previous-translation {
      font-size: 1rem;
      color: #ccc;
    }

    /* ================ Contenedor de imágenes ================= */
    .sentence-image {
      width: 100%;
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 0.1rem;
    }
    .sentence-image .img-item {
      flex: 1 1 calc(33.333% - 0.5rem);
      max-width: calc(33.333% - 0.5rem);
      background-color: #4a4a4a;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    .sentence-image .img-item .inner {
      position: relative;
      width: 100%;
      padding-top: 75%; /* 4:3 ratio */
    }
    .sentence-image .img-item .spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      color: #888;
      animation: spin 1s linear infinite;
      z-index: 1;
    }
    @keyframes spin {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to   { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .sentence-image .no-images {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #aaa;
      font-size: 0.9rem;
      padding: 1rem;
      text-align: center;
    }
    .sentence-image .img-item img {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    /* ================ Frase y palabras ================= */
    .sentence-phrase {
      width: 100%;
      background-color: #3b3b3b;
      border: 2px solid #4a4a4a;
      border-radius: 6px;
      padding: 0.5rem;
    }
    .sentence-phrase h2 {
      text-align: center;
      margin-bottom: 0.6rem;
      font-size: 1.4rem;
      letter-spacing: 0.4px;
    }
    .words-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      justify-content: center;
    }
    .word-box {
      background-color: #2e2e2e;
      border: 2px solid #4a4a4a;
      border-radius: 6px;
      padding: 0.4rem;
      text-align: center;
      word-wrap: break-word;
      flex: 0 1 auto;
      min-width: 80px;
      position: relative;
    }
    .word-box.blank {
      background-color: #495057;
      border-color: #6c757d;
      color: #adb5bd;
    }
    .word-box.correct {
      background-color: #28a745;
      border-color: #1e7e34;
    }
    .word-box.incorrect {
      background-color: #dc3545;
      border-color: #bd2130;
    }
    .word-box .english {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.2rem;
      line-height: 1.1;
      word-wrap: break-word;
    }
    .word-box .pronunciation {
      font-size: 1.2rem;
      color: #a0a0a0;
      margin-bottom: 0.1rem;
    }
    .word-box .espanol {
      font-size: 0.9rem;
      color: #a0a0a0;
      margin-bottom: 0.1rem;
    }
    .word-box .part-of-speech {
      font-size: 0.8rem;
      color: #ccc;
    }
    /* Span para mostrar blanks o letras */
    .blank-text {
      display: inline-block;
      min-width: 40px;
      border-bottom: 2px dotted #adb5bd;
      font-size: 1.6rem;
      font-weight: 600;
    }

    /* ================ Instruction (debajo de sentence-phrase) ================= */
    .instruction {
      width: 100%;
      background-color: #343a40;
      border: 2px solid #495057;
      border-radius: 6px;
      padding: 0.5rem;
      margin-top: 0.5rem;
      text-align: center;
      font-size: 0.95rem;
    }
    .instruction h1 {
      font-size: 1.1rem;
      color: #ffc107;
    }

    /* ================ Botones de navegación ================= */
    .actions-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.4rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    .actions-row button {
      font-size: 1rem;
      padding: 0.6rem 1.2rem;
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .actions-row button:hover {
      background: linear-gradient(135deg, #0056b3 0%, #00408d 100%);
    }

    /* ================ Botones de actividades ================= */
    .activity-buttons {
      width: 100%;
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 0.4rem;
    }
    .activity-buttons button {
      flex: 1 1 30%;
      min-width: 100px;
      font-size: 1rem;
      padding: 0.6rem 1.2rem;
      background: linear-gradient(135deg, #6f42c1 0%, #551a8b 100%);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
    }
    .activity-buttons button.completed {
      background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    }
    .activity-buttons button:hover {
      background: linear-gradient(135deg, #551a8b 0%, #3f0d6f 100%);
    }

    /* ================ Contenedor de alternativas ================= */
    .alternatives {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .alternative-group {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.3rem;
    }
    .alternative-group button {
      width: 100%;
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .alternative-group button:hover {
      background: linear-gradient(135deg, #e0a800 0%, #c69500 100%);
    }

    /* ================ Drag & Drop estilos ================= */
    .draggable {
      cursor: grab;
    }
    .drag-over {
      border: 2px dashed #ffc107 !important;
    }

    /* ================ Pop-up felicitaciones ================= */
    #popup-message {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(40, 167, 69, 0.95);
      color: #fff;
      padding: 1.5rem 2rem;
      border-radius: 8px;
      box-shadow: 0 8px 12px rgba(0,0,0,0.3);
      z-index: 2000;
      text-align: center;
      min-width: 250px;
    }
    #popup-message h2 {
      margin-bottom: 0.5rem;
      font-size: 1.3rem;
    }

    /* ================= Modal de Gramática ================= */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 1rem;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background-color: #3b3b3b;
      padding: 1rem;
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    .modal-content h3 {
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    .modal-close {
      position: absolute;
      top: 0.4rem;
      right: 0.4rem;
      background: none;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }

    /* ================= Pie de página ================= */
    footer.footer {
      width: 100%;
      max-width: 800px;
      text-align: center;
      font-size: 0.75rem;
      color: #888;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #444;
    }

    /* ================= Media Queries ================= */
    @media (max-width: 480px) {
      .sentence-image .img-item {
        flex: 1 1 100%;
        max-width: 100%;
      }
      .activity-buttons button {
        flex: 1 1 calc(40% - 0.5rem);
      }
      .alternative-group button {
        flex: 1 1 45%;
      }
    }
    @media (min-width: 480px) {
      .sentence-phrase h2 {
        font-size: 1.4rem;
      }
      .word-box {
        min-width: 100px;
      }
      .actions-row button {
        font-size: 1rem;
        padding: 0.6rem 1.2rem;
      }
    }
    @media (min-width: 640px) {
      h1 {
        font-size: 2rem;
      }
      .level-bar button {
        font-size: 1.05rem;
        padding: 0.6rem 1.2rem;
      }
      .topics-container {
        gap: 0.75rem;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
      .sentence-phrase h2 {
        font-size: 1.6rem;
      }
      .actions-row button {
        font-size: 1.1rem;
        padding: 0.7rem 1.4rem;
      }
      footer.footer {
        font-size: 0.8rem;
        margin-top: 2.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="main-title">Inglés práctico por frases</h1>

    <div class="level-bar" id="level-bar">
      <button data-level="fundamental" class="active">Fundamental</button>
      <button data-level="basic">Básico</button>
      <button data-level="intermediate">Intermedio</button>
      <button data-level="advanced">Avanzado</button>
    </div>

    <div class="topics-container" id="topics-container"></div>

    <div class="sentence-view" id="sentence-view">
      <!-- Controles superiores: "Volver a Temas" y "Ver Gramática" -->
      <div class="top-controls">
        <button class="btn-back-topics" id="btn-back-topics">
          ← Volver a Temas
        </button>
        <button id="btn-view-grammar">
          <i class="fa-solid fa-book"></i> Ver Gramática
        </button>
      </div>

      <!-- Texto anterior probable y su traducción -->
      <div class="previous-container">
        <div id="previous-text" class="previous-text"></div>
        <div id="previous-translation" class="previous-translation"></div>
      </div>

      <!-- Contenedor de 3 imágenes (responsive) -->
      <div class="sentence-image" id="sentence-image">
        <!-- Aquí JavaScript inyectará .img-item -->
      </div>

      <!-- Frase y palabras -->
      <div class="sentence-phrase">
        <h2 id="sentence-title">Título de la frase</h2>
        <div class="words-grid" id="words-grid"></div>
      </div>

      <!-- Div de instrucciones (debajo de sentence-phrase) -->
      <div id="instruction-container"></div>

      <!-- Contenedor de alternativas dinámicas -->
      <div class="alternatives" id="alternatives"></div>

      <!-- Botones de navegación -->
      <div class="actions-row">
        <button id="btn-prev">
          <i class="fa-solid fa-arrow-left"></i> Previous
        </button>
        <button id="btn-play">
          <i class="fa-solid fa-play"></i> Play
        </button>
        <button id="btn-next">
          Next <i class="fa-solid fa-arrow-right"></i>
        </button>
      </div>

      <!-- Botones de actividades -->
      <div class="activity-buttons">
        <button id="actividad-1">
          <i class="fa-solid fa-pencil"></i> Actividad 1
        </button>
        <button id="actividad-2">
          <i class="fa-solid fa-edit"></i> Actividad 2
        </button>
        <button id="actividad-3">
          <i class="fa-solid fa-arrows-up-down-left-right"></i> Actividad 3
        </button>
      </div>
    </div>
  </div>

  <!-- Pop-up felicitaciones -->
  <div id="popup-message">
    <h2 id="popup-text">¡Felicidades!</h2>
  </div>

  <!-- Modal de Gramática -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-content">
      <button class="modal-close" id="modal-close">
        <i class="fa-solid fa-xmark"></i>
      </button>
      <div id="modal-body"></div>
    </div>
  </div>

  <footer class="footer">Diseñado profesionalmente – © 2025</footer>

  <script>
    (function () {
      const WORKER_BASE = "https://sentences.saturninocok.workers.dev";
      const PEXELS_API_KEY = "aV5EuNmfMhHpLQYMjCOQp6YWmU6RAF5M6at5jDTRpe0pLwxk1SZzPhSC";

      let currentLevel = "fundamental";
      let allData = [];
      let temasUnicos = [];
      let sentencesOfCurrentTopic = [];
      let currentSentenceIndex = 0;

      // Guardar estado original de palabras para poder restaurar
      let originalWords = [];            // Array de strings
      let wordObjects = [];              // Array de objetos palabra (para referencia)
      let similarWordsByWord = [];       // Array de arrays con alternativas

      // Para Activity 1
      let missingIndices = [];           // índices de palabras ocultas
      let currentMissingPointer = 0;     // puntero a la palabra faltante actual

      // Para Activity 2
      let letterBlanksInfo = []; // { index, maskedWord, missingIndices, originalWord }

      // Para Activity 3
      let draggedElement = null;   // referencia al elemento arrastrado
      let selectedBox = null;      // fallback click-swap en móvil

      // Elementos DOM
      const mainTitle = document.getElementById("main-title");
      const levelBar = document.getElementById("level-bar");
      const levelButtons = document.querySelectorAll(".level-bar button");
      const topicsContainer = document.getElementById("topics-container");
      const sentenceView = document.getElementById("sentence-view");
      const sentenceImage = document.getElementById("sentence-image");
      const previousText = document.getElementById("previous-text");
      const previousTranslation = document.getElementById("previous-translation");
      const sentenceTitle = document.getElementById("sentence-title");
      const wordsGrid = document.getElementById("words-grid");
      const btnViewGrammar = document.getElementById("btn-view-grammar");
      const btnPrev = document.getElementById("btn-prev");
      const btnNext = document.getElementById("btn-next");
      const btnPlay = document.getElementById("btn-play");
      const btnBackTopics = document.getElementById("btn-back-topics");
      const actividad1 = document.getElementById("actividad-1");
      const actividad2 = document.getElementById("actividad-2");
      const actividad3 = document.getElementById("actividad-3");
      const modalOverlay = document.getElementById("modal-overlay");
      const modalBody = document.getElementById("modal-body");
      const modalClose = document.getElementById("modal-close");
      const instructionContainer = document.getElementById("instruction-container");
      const alternativesContainer = document.getElementById("alternatives");
      const popupMessage = document.getElementById("popup-message");
      const popupText = document.getElementById("popup-text");

      // Detectar si es dispositivo táctil (para fallback de ordenar)
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

      document.addEventListener("DOMContentLoaded", () => {
        fetchDataForLevel("fundamental");
      });

      // -----------------------
      // 1) Cambiar nivel
      // -----------------------
      function switchLevel(level) {
        cleanupActivities();
        currentLevel = level;
        levelButtons.forEach((btn) => {
          if (btn.dataset.level === level) btn.classList.add("active");
          else btn.classList.remove("active");
        });
        hideSentenceView();
        fetchDataForLevel(level);
      }

      // -----------------------
      // 2) Obtener data desde Worker
      // -----------------------
      async function fetchDataForLevel(level) {
        try {
          const resp = await fetch(`${WORKER_BASE}/${level}`, {
            method: "GET",
            mode: "cors",
          });
          if (!resp.ok) throw new Error("No se obtuvo data");
          const text = await resp.text();
          allData = JSON.parse(text);
          const temasSet = new Set(allData.map((item) => item.tema));
          temasUnicos = Array.from(temasSet);
          renderTopicsList();
        } catch (err) {
          console.error("Error cargando data:", err);
          topicsContainer.innerHTML =
            '<p style="color:#faa">No se pudo cargar los temas.</p>';
        }
      }

      // -----------------------
      // 3) Renderizar lista de temas
      // -----------------------
      function renderTopicsList() {
        topicsContainer.innerHTML = "";
        if (temasUnicos.length === 0) {
          topicsContainer.innerHTML =
            '<p style="color:#ccc">No hay temas disponibles.</p>';
          return;
        }
        temasUnicos.forEach((tema) => {
          const btn = document.createElement("button");
          btn.textContent = tema;
          btn.addEventListener("click", () => selectTopic(tema));
          topicsContainer.appendChild(btn);
        });
      }

      // -----------------------
      // 4) Seleccionar tema
      // -----------------------
      function selectTopic(tema) {
        cleanupActivities();
        mainTitle.style.display = "none";
        levelBar.style.display = "none";
        topicsContainer.style.display = "none";
        sentencesOfCurrentTopic = allData.filter(
          (item) => item.tema === tema
        );
        currentSentenceIndex = 0;
        sentenceView.classList.add("active");
        renderCurrentSentence();
      }

      // -----------------------
      // 5) Renderizar frase actual
      // -----------------------
      async function renderCurrentSentence() {
        cleanupActivities();
        // Al cambiar frase, reiniciar botones de actividad
        [actividad1, actividad2, actividad3].forEach(btn => {
          btn.classList.remove("completed");
          const icon = btn.querySelector(".fa-check");
          if (icon) icon.remove();
        });

        const data = sentencesOfCurrentTopic[currentSentenceIndex];
        if (!data) return;

        // Guardar palabras originales y sus listas de similares
        originalWords = data.oracion.palabras.map((w) => w.ingles);
        wordObjects = data.oracion.palabras.slice(); // copia de objetos
        similarWordsByWord = Array.isArray(data.palabras_similares_por_palabra)
          ? data.palabras_similares_por_palabra.slice()
          : []; // array de arrays de 4 strings

        // Texto anterior probable y traducción
        previousText.textContent = data.anterior_probable || "";
        previousTranslation.textContent =
          data.traduccion_anterior_probable || "";

        // Título de la frase en español
        sentenceTitle.textContent = data.oracion.espanol;

        // Renderizar palabras
        wordsGrid.innerHTML = "";
        data.oracion.palabras.forEach((wordObj, idx) => {
          const box = document.createElement("div");
          box.className = "word-box";
          box.dataset.index = idx;
          box.innerHTML = `
            <div class="english">${wordObj.ingles}</div>
            <div class="pronunciation">${wordObj.pronunciacion}</div>
            <div class="espanol">${wordObj.espanol}</div>
            <div class="part-of-speech">${wordObj.tipo}</div>
          `;
          wordsGrid.appendChild(box);
        });

        // Renderizar imágenes
        const tags = Array.isArray(data.imagenes) ? data.imagenes : [];
        await fetchAndDisplayImages(tags);
      }

      // -----------------------
      // 6) Obtener y mostrar imágenes (solo 3, sin duplicados)
      // -----------------------
      async function fetchAndDisplayImages(tags) {
        sentenceImage.innerHTML = "";
        if (!Array.isArray(tags)) tags = [];
        const fillTags = tags.slice(0, 3);
        while (fillTags.length < 3) fillTags.push(null);

        for (let i = 0; i < 3; i++) {
          const tag = fillTags[i];
          const div = document.createElement("div");
          div.className = "img-item";
          const inner = document.createElement("div");
          inner.className = "inner";
          const spinner = document.createElement("i");
          spinner.className = "fa-solid fa-spinner spinner";
          inner.appendChild(spinner);
          div.appendChild(inner);
          sentenceImage.appendChild(div);

          if (!tag) {
            spinner.remove();
            inner.innerHTML = `<div class="no-images">Sin etiqueta</div>`;
            continue;
          }

          const tempImg = new Image();
          tempImg.alt = tag;
          tempImg.onload = () => {
            const img = document.createElement("img");
            img.src = tempImg.src;
            img.alt = tempImg.alt;
            inner.appendChild(img);
            spinner.remove();
            img.style.display = "block";
          };
          tempImg.onerror = () => {
            spinner.remove();
            inner.innerHTML = `<div class="no-images">Sin imagen para "${tag}"</div>`;
          };

          try {
            const resp = await fetch(
              `https://api.pexels.com/v1/search?query=${encodeURIComponent(tag)}&per_page=1`,
              {
                headers: {
                  Authorization: PEXELS_API_KEY,
                },
              }
            );
            if (!resp.ok) throw new Error("No se obtuvieron imágenes");
            const json = await resp.json();
            const photo = Array.isArray(json.photos) && json.photos.length
              ? json.photos[0]
              : null;
            if (photo && photo.src) {
              tempImg.src = photo.src.medium;
            } else {
              spinner.remove();
              inner.innerHTML = `<div class="no-images">Sin imagen para "${tag}"</div>`;
            }
          } catch (err) {
            console.error(`Error cargando imagen para "${tag}":`, err);
            spinner.remove();
            inner.innerHTML = `<div class="no-images">Error al cargar imagen de "${tag}"</div>`;
          }
        }
      }

      // -----------------------
      // 7) Ocultar vista de frase y volver a temas
      // -----------------------
      function hideSentenceView() {
        cleanupActivities();
        sentenceView.classList.remove("active");
        mainTitle.style.display = "block";
        levelBar.style.display = "flex";
        topicsContainer.style.display = "grid";
      }

      // -----------------------
      // 8) Navegar a frase anterior
      // -----------------------
      function goToPreviousSentence() {
        if (currentSentenceIndex > 0) {
          currentSentenceIndex--;
          renderCurrentSentence();
        }
      }

      // -----------------------
      // 9) Navegar a frase siguiente
      // -----------------------
      function goToNextSentence() {
        if (currentSentenceIndex < sentencesOfCurrentTopic.length - 1) {
          currentSentenceIndex++;
          renderCurrentSentence();
        }
      }

      // -----------------------
      // 10) Play: resetear todo
      // -----------------------
      function handlePlay() {
        cleanupActivities();
        renderCurrentSentence();
      }

      // -----------------------
      // 11) Mostrar modal de gramática
      // -----------------------
      function openGrammarModal() {
        const data = sentencesOfCurrentTopic[currentSentenceIndex];
        if (!data) return;
        modalBody.innerHTML = data.grammar;
        modalOverlay.classList.add("active");
      }
      function closeGrammarModal() {
        modalOverlay.classList.remove("active");
      }

      // -----------------------
      // 12) Activity 1: completar palabras faltantes usando “palabras_similares_por_palabra”
      // -----------------------
      function startActivity1() {
        cleanupActivities();
        instructionContainer.innerHTML = `
          <div class="instruction">
            <h1>Actividad 1: completa las palabras faltantes</h1>
          </div>`;

        missingIndices = [];
        currentMissingPointer = 0;

        // Recoger "palabras_similares_por_palabra" de la data actual
        similarWordsByWord = Array.isArray(sentencesOfCurrentTopic[currentSentenceIndex].palabras_similares_por_palabra)
          ? sentencesOfCurrentTopic[currentSentenceIndex].palabras_similares_por_palabra.slice()
          : [];

        // Verificar que la longitud coincida; si no, mostramos un warning y usamos fallback
        if (similarWordsByWord.length !== originalWords.length) {
          console.warn("La data 'palabras_similares_por_palabra' no coincide con el número de palabras. Se usará fallback.");
        }

        // Decidir aleatoriamente cuántas palabras ocultar (60% aprox, mínimo 2, máximo n-1)
        const numWords = originalWords.length;
        const countBlanks = Math.min(
          numWords - 1,
          Math.max(2, Math.floor(numWords * 0.6))
        );
        while (missingIndices.length < countBlanks) {
          const rand = Math.floor(Math.random() * numWords);
          if (!missingIndices.includes(rand)) missingIndices.push(rand);
        }
        missingIndices.sort((a, b) => a - b);

        // Renderizar blanks en esas posiciones
        const boxes = Array.from(wordsGrid.children);
        missingIndices.forEach((idx) => {
          const box = boxes[idx];
          box.classList.add("blank");
          box.innerHTML = `<span class="blank-text" data-index="${idx}">____</span>`;
        });

        // Mostrar alternativas de la primera palabra faltante
        showNextAlternatives();
      }

      // Muestra las alternativas para la palabra faltante actual
      function showNextAlternatives() {
        alternativesContainer.innerHTML = "";
        // Si ya completamos todas las faltantes, felicitamos
        if (currentMissingPointer >= missingIndices.length) {
          showPopup("¡Felicidades, completaste la Actividad 1!");
          markActivityCompleted(actividad1);
          return;
        }

        const wordIdx = missingIndices[currentMissingPointer];
        let options = [];
        // Si existe el array de palabras_similares_por_palabra apropiado
        if (
          Array.isArray(similarWordsByWord) &&
          similarWordsByWord[wordIdx] &&
          Array.isArray(similarWordsByWord[wordIdx]) &&
          similarWordsByWord[wordIdx].length
        ) {
          options = similarWordsByWord[wordIdx].slice();
        } else {
          // Fallback: palabra correcta + 3 distractores genéricos
          const correct = originalWords[wordIdx];
          const generic = ["apple", "dog", "run", "book", "house", "tree", "car", "sun"];
          options = [correct];
          while (options.length < 4) {
            const cand = generic[Math.floor(Math.random() * generic.length)];
            if (!options.includes(cand)) options.push(cand);
          }
        }

        // Ordenar alfabéticamente en lugar de mezclar
        options.sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));

        const groupDiv = document.createElement("div");
        groupDiv.className = "alternative-group";
        options.forEach((opt) => {
          const btn = document.createElement("button");
          btn.textContent = opt;
          btn.dataset.targetIndex = wordIdx;
          btn.addEventListener("click", () => {
            handleActivity1Click(wordIdx, opt);
          });
          groupDiv.appendChild(btn);
        });
        alternativesContainer.appendChild(groupDiv);
      }

      function handleActivity1Click(idx, chosen) {
        const correctWord = originalWords[idx];
        const box = wordsGrid.children[idx];

        if (correctWord.toLowerCase() === chosen.toLowerCase()) {
          box.classList.remove("blank");
          box.classList.add("correct");
          box.innerHTML = `<div class="english">${correctWord}</div>`;

          currentMissingPointer++;
          if (currentMissingPointer < missingIndices.length) {
            showNextAlternatives();
          } else {
            alternativesContainer.innerHTML = "";
            showPopup("¡Felicidades, completaste la Actividad 1!");
            markActivityCompleted(actividad1);
          }
        } else {
          box.classList.add("incorrect");
          setTimeout(() => box.classList.remove("incorrect"), 800);
        }
      }

      // -----------------------
      // 13) Activity 2: completar letras faltantes (todas las palabras)
      // -----------------------
function startActivity2() {
  // Limpiar pantalla y mostrar instrucción
  cleanupActivities();
  instructionContainer.innerHTML = `
    <div class="instruction">
      <h1>Actividad 2: completa las letras faltantes</h1>
    </div>`;
  letterBlanksInfo = [];

  // Enmascarar todas las palabras según su longitud
  const boxes = Array.from(wordsGrid.children);
  originalWords.forEach((word, idx) => {
    const len = word.length;
    // Calcular cuántas letras ocultar (40% de la longitud, mínimo 1, máximo len-1)
    const numMissing = Math.min(Math.max(1, Math.floor(len * 0.4)), len - 1);
    const posSet = new Set();
    while (posSet.size < numMissing) {
      const p = Math.floor(Math.random() * len);
      if (!posSet.has(p)) posSet.add(p);
    }
    const missingIdxs = Array.from(posSet).sort();

    // Construir la versión enmascarada de la palabra
    let masked = "";
    for (let i = 0; i < len; i++) {
      masked += missingIdxs.includes(i) ? "_" : word[i];
    }

    // Guardar información para verificar después
    letterBlanksInfo.push({
      index: idx,
      originalWord: word,
      maskedWord: masked,
      missingIndices: missingIdxs
    });

    // Mostrar la palabra enmascarada dentro de su caja
    const box = boxes[idx];
    box.classList.add("blank");
    box.innerHTML = `<span class="blank-text" data-index="${idx}">${masked}</span>`;
  });

  // Crear un único contenedor .alternative-group para todas las letras faltantes
  alternativesContainer.innerHTML = "";
  const groupDiv = document.createElement("div");
  groupDiv.className = "alternative-group";

  // Para cada palabra y para cada índice faltante, generar 3 opciones (1 correcta + 2 distractores)
  letterBlanksInfo.forEach((info) => {
    info.missingIndices.forEach((pos) => {
      const correctLetter = info.originalWord[pos].toUpperCase();
      const options = [correctLetter];
      const lettersPool = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

      // Generar 2 distractores aleatorios
      while (options.length < 3) {
        const cand = lettersPool[Math.floor(Math.random() * lettersPool.length)];
        if (!options.includes(cand)) options.push(cand);
      }

      // Ordenar alfabéticamente antes de crear los botones
      options.sort((a, b) => a.localeCompare(b));

      // Crear un botón para cada opción
      options.forEach((opt) => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.dataset.targetWord = info.index;
        btn.dataset.targetPos = pos;
        btn.addEventListener("click", () => {
          handleActivity2Click(info.index, pos, opt, btn);
        });
        groupDiv.appendChild(btn);
      });
    });
  });

  // Agregar el grupo único de alternativas al contenedor
  alternativesContainer.appendChild(groupDiv);
}


      function handleActivity2Click(idx, pos, chosen, btn) {
        const info = letterBlanksInfo.find((b) => b.index === idx);
        const box = wordsGrid.children[idx];
        const blankSpan = box.querySelector(".blank-text");
        let currentMask = blankSpan.textContent.split("");

        if (info.originalWord[pos].toUpperCase() === chosen.toUpperCase()) {
          // Correcto: reemplazar "_" en esa posición
          currentMask[pos] = info.originalWord[pos];
          blankSpan.textContent = currentMask.join("");
          btn.disabled = true;
          btn.style.opacity = "0.6";

          // Cuando no quede ningún guión "_" en este span, marcamos la palabra como correcta
          if (!currentMask.includes("_")) {
            box.classList.remove("blank");
            box.classList.add("correct");
            // Deshabilitar todos botones de esa palabra
            const groupBtns = Array.from(alternativesContainer.querySelectorAll(`button[data-target-word="${idx}"]`));
            groupBtns.forEach((b) => (b.disabled = true));
          }

          // ¡AVISAR SI TODAS LAS PALABRAS ESTÁN COMPLETAS!
          checkActivity2Completion();
        } else {
          // Incorrecto: parpadeo rojo
          box.classList.add("incorrect");
          setTimeout(() => box.classList.remove("incorrect"), 800);
        }
      }

      function checkActivity2Completion() {
        // Buscamos si existe al menos un span ".blank-text" que contenga "_"
        const allBlankSpans = Array.from(document.querySelectorAll(".blank-text"));
        const stillHasUnderscore = allBlankSpans.some((span) =>
          span.textContent.includes("_")
        );
        if (!stillHasUnderscore) {
          // Entonces ya completamos todas las letras faltantes
          showPopup("¡Felicidades, completaste la Actividad 2!");
          markActivityCompleted(actividad2);
        }
      }

      // -----------------------
      // 14) Activity 3: ordenar la frase (Drag & Drop & Fallback táctil)
      // -----------------------
      function startActivity3() {
        cleanupActivities();
        instructionContainer.innerHTML = `
          <div class="instruction">
            <h1>Actividad 3: arrastra cada palabra a su posición correcta</h1>
          </div>`;
        // Desordenar word-boxes
        const boxes = Array.from(wordsGrid.children);
        const shuffled = boxes.slice().sort(() => Math.random() - 0.5);
        wordsGrid.innerHTML = "";
        shuffled.forEach((box) => {
          box.classList.add("draggable");
          box.setAttribute("draggable", "true");
          wordsGrid.appendChild(box);
        });

        // Añadir eventos Drag & Drop o fallback táctil
        const updatedBoxes = Array.from(wordsGrid.children);
        updatedBoxes.forEach((box) => {
          if (!isTouchDevice) {
            // Desktop: HTML5 Drag & Drop
            box.addEventListener("dragstart", handleDragStart);
            box.addEventListener("dragover", handleDragOver);
            box.addEventListener("drop", handleDrop);
            box.addEventListener("dragenter", handleDragEnter);
            box.addEventListener("dragleave", handleDragLeave);
            box.addEventListener("dragend", handleDragEnd);
          } else {
            // Móvil: click-swap
            box.addEventListener("click", handleTouchSelect);
          }
        });
      }

      // ===== Drag & Drop para Desktop =====
      function handleDragStart(e) {
        draggedElement = this;
        this.style.opacity = "0.4";
      }
      function handleDragOver(e) {
        e.preventDefault(); // Necesario para permitir drop
      }
      function handleDragEnter(e) {
        if (this !== draggedElement) this.classList.add("drag-over");
      }
      function handleDragLeave(e) {
        this.classList.remove("drag-over");
      }
      function handleDrop(e) {
        e.preventDefault();
        const targetBox = this;
        if (draggedElement && targetBox !== draggedElement) {
          // Intercambiar nodos
          const parent = wordsGrid;
          const draggedNext = draggedElement.nextSibling === targetBox ? draggedElement : draggedElement.nextSibling;
          parent.insertBefore(draggedElement, targetBox);
          parent.insertBefore(targetBox, draggedNext);

          // Actualizar data-index
          Array.from(wordsGrid.children).forEach((child, idx) => {
            child.dataset.index = idx;
          });

          checkActivity3Completion();
        }
        targetBox.classList.remove("drag-over");
      }
      function handleDragEnd(e) {
        this.style.opacity = "1";
        Array.from(wordsGrid.children).forEach((box) => {
          box.classList.remove("drag-over");
        });
      }

      // ===== Click-swap para Móvil =====
      function handleTouchSelect(e) {
        const box = e.currentTarget;
        if (!selectedBox) {
          // Primera selección
          selectedBox = box;
          box.classList.add("drag-over");
        } else if (selectedBox === box) {
          // Desmarcar si es la misma
          box.classList.remove("drag-over");
          selectedBox = null;
        } else {
          // Segunda selección: intercambiar posiciones
          const srcBox = selectedBox;
          const destBox = box;
          const parent = wordsGrid;
          const srcNext = srcBox.nextSibling === destBox ? srcBox : srcBox.nextSibling;

          parent.insertBefore(srcBox, destBox);
          parent.insertBefore(destBox, srcNext);

          // Actualizar data-index
          Array.from(wordsGrid.children).forEach((child, idx) => {
            child.dataset.index = idx;
          });

          selectedBox.classList.remove("drag-over");
          selectedBox = null;
          checkActivity3Completion();
        }
      }

      function checkActivity3Completion() {
        const boxes = Array.from(wordsGrid.children);
        const correct = boxes.every((box, i) => {
          return box.querySelector(".english").textContent === originalWords[i];
        });
        if (correct) {
          showPopup("¡Felicidades, completaste la Actividad 3!");
          markActivityCompleted(actividad3);
        }
      }

      // -----------------------
      // 15) Cleanup / Reset Activities
      // -----------------------
      function cleanupActivities() {
        // Quitar instrucciones
        instructionContainer.innerHTML = "";
        // Quitar alternativas
        alternativesContainer.innerHTML = "";
        // Restaurar palabra original en word-boxes
        if (originalWords.length) {
          wordsGrid.innerHTML = "";
          wordObjects.forEach((wordObj, idx) => {
            const box = document.createElement("div");
            box.className = "word-box";
            box.dataset.index = idx;
            box.innerHTML = `
              <div class="english">${wordObj.ingles}</div>
              <div class="pronunciation">${wordObj.pronunciacion}</div>
              <div class="espanol">${wordObj.espanol}</div>
              <div class="part-of-speech">${wordObj.tipo}</div>
            `;
            wordsGrid.appendChild(box);
          });
        }
        // Reiniciar estado de selección táctil
        selectedBox = null;
        // No re-renderizar imágenes aquí
      }

      // -----------------------
      // 16) Señalización de botón completado
      // -----------------------
      function markActivityCompleted(btn) {
        if (!btn.classList.contains("completed")) {
          btn.classList.add("completed");
          const checkIcon = document.createElement("i");
          checkIcon.className = "fa-solid fa-check";
          btn.prepend(checkIcon);
        }
      }

      // -----------------------
      // 17) Pop-up felicitaciones
      // -----------------------
      function showPopup(message) {
        popupText.textContent = message;
        popupMessage.style.display = "block";
        setTimeout(() => {
          popupMessage.style.display = "none";
        }, 2000);
      }

      // -----------------------
      // Eventos Principales
      // -----------------------
      levelButtons.forEach((btn) => {
        btn.addEventListener("click", () =>
          switchLevel(btn.dataset.level)
        );
      });

      btnPrev.addEventListener("click", goToPreviousSentence);
      btnNext.addEventListener("click", goToNextSentence);
      btnPlay.addEventListener("click", handlePlay);
      btnViewGrammar.addEventListener("click", openGrammarModal);
      btnBackTopics.addEventListener("click", hideSentenceView);

      actividad1.addEventListener("click", startActivity1);
      actividad2.addEventListener("click", startActivity2);
      actividad3.addEventListener("click", startActivity3);

      modalClose.addEventListener("click", closeGrammarModal);
      modalOverlay.addEventListener("click", (ev) => {
        if (ev.target === modalOverlay) closeGrammarModal();
      });
    })();
  </script>
</body>
</html>
